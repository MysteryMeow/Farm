<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Inventory Tracker</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container mt-4">
<h1 class="text-center mb-4">BerZirk Inventory Tracker</h1>
<h6 class="text-center mb-4">Software Created and Developed by Ron Zirk</h6>
<div class="text-end">
<a class="btn btn-danger" href="{{ url_for('logout') }}">Logout</a>
</div>
<div class="card p-4 shadow-sm mb-4">
<h3 class="text-center mb-3">Log Item Usage</h3>
<form class="row g-3" id="logForm">
<div class="col-md-6">
<select class="form-control" name="item" required="">
                        {% for row in data %}
                            <option value="{{ row['Item'] }}">{{ row['Item'] }}</option>
                        {% endfor %}
                    </select>
</div>
<div class="col-md-4">
<input class="form-control" min="1" name="quantity" placeholder="Quantity Used" required="" type="number"/>
</div>
<div class="col-md-2">
<button class="btn btn-primary w-100" type="submit">Log</button>
</div>
</form>
</div>
<div class="card p-4 shadow-sm mb-4">
<h3 class="text-center mb-3">Restock Items</h3>
<form class="row g-3" id="addItemForm">
<div class="col-md-6">
<select class="form-control" name="item" required="">
                        {% for row in data %}
                            <option value="{{ row['Item'] }}">{{ row['Item'] }}</option>
                        {% endfor %}
                    </select>
</div>
<div class="col-md-4">
<input class="form-control" min="1" name="stock" placeholder="Initial Stock" required="" type="number"/>
</div>
<div class="col-md-2">
<button class="btn btn-success w-100" type="submit">Add</button>
</div>
</form>
</div>
<div class="table-responsive shadow-sm">
<h3 class="text-center mb-3">Current Stock</h3>
<div id="stockAccordion" class="accordion">
    {% set grouped = {} %}
    {% for row in data %}
        {% set cat = row['Category'] or 'Uncategorized' %}
        {% if cat not in grouped %}
            {% set _ = grouped.update({cat: []}) %}
        {% endif %}
        {% set _ = grouped[cat].append(row) %}
    {% endfor %}

    {% for category in grouped.keys()|sort %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ loop.index }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false" aria-controls="collapse-{{ loop.index }}">
                {{ category }}
            </button>
        </h2>
        <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#stockAccordion">
            <div class="accordion-body">
                <table class="table table-striped table-bordered mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Item</th>
                            <th>Stock</th>
                            <th>Used</th>
                            <th>Remaining</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in grouped[category]|sort(attribute='Item') %}
                        <tr>
                            <td>{{ row['Item'] }}</td>
                            <td>{{ row['Stock'] }}</td>
                            <td>{{ row['Used'] }}</td>
                            <td>{{ row['Remaining'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

</div>

        {% if role == "Admin" %}
        <div class="d-flex justify-content-center mt-4 flex-wrap gap-3">
<button class="btn btn-success" id="exportButton">Export Stock Data</button>
<button class="btn btn-info" id="mostUsedReportButton">Download Most Used Report</button>
<button class="btn btn-warning" id="employeeReportButton">Download Employee Report</button>
<button class="btn btn-secondary" id="downloadLogButton">Download Log</button>
<a class="btn btn-primary" href="{{ url_for('register') }}">Register New User</a>
<a class="btn btn-secondary" href="/admin">Admin Dashboard</a>
</div>
        {% endif %}

        <!-- Charts Section -->
<div class="mt-5">
<h3 class="text-center mb-3">Most Used Items</h3>
<canvas id="mostUsedChart"></canvas>
</div>
<div id="usageTrendsChartContainer">
<canvas id="usageTrendsChart"></canvas>
</div>
<div class="mt-5">
<h3 class="text-center mb-3">Employee Usage</h3>
<canvas id="employeeUsageChart"></canvas>
</div>
</div>
<script>
        // Handle logging item usage
        document.getElementById("logForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/log", { method: "POST", body: formData })
                .then(response => response.json())
                .then(data => { alert(data.message); location.reload(); });
        });

        // Handle adding new items
        document.getElementById("addItemForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/add-item", { method: "POST", body: formData })
                .then(response => response.json())
                .then(data => { alert(data.message); location.reload(); });
        });

        // Fetch and render Most Used Items chart
        fetch("/report/most-used-data")
            .then(response => response.json())
            .then(data => {
                new Chart(document.getElementById("mostUsedChart"), {
                    type: "bar",
                    data: {
                        labels: Object.keys(data),
                        datasets: [{ label: "Most Used Items", data: Object.values(data), backgroundColor: "rgba(75, 192, 192, 0.2)", borderColor: "rgba(75, 192, 192, 1)", borderWidth: 1 }]
                    }
                });
            });

        let usageTrendsChart; // Store chart instance globally

    function fetchUsageTrendsChart() {
        fetch("/report/usage-trends-data")
            .then(response => response.json())
            .then(data => {
                if (Object.keys(data).length === 0) {
                    console.warn("No data available for Usage Trends Over Time");
                    return;
                }

                const canvasContainer = document.getElementById("usageTrendsChartContainer");

                // Completely remove the old canvas and replace it with a new one
                canvasContainer.innerHTML = '<canvas id="usageTrendsChart"></canvas>';
                const ctx = document.getElementById("usageTrendsChart").getContext("2d");

                // Destroy previous chart instance if it exists
                if (usageTrendsChart) {
                    usageTrendsChart.destroy();
                }

                // Extract unique dates
                let allDates = new Set();
                for (let item in data) {
                    Object.keys(data[item]).forEach(date => allDates.add(date));
                }
                let sortedDates = Array.from(allDates).sort();

                // Prepare datasets for each item
                let datasets = [];
                for (let item in data) {
                    let itemData = sortedDates.map(date => data[item][date] || 0);

                    datasets.push({
                        label: item,
                        data: itemData,
                        borderWidth: 2,
                        fill: false,
                        borderColor: getRandomColor(),
                        backgroundColor: getRandomColor()
                    });
                }

                // Create new chart
                usageTrendsChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: sortedDates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: "Date" } },
                            y: { title: { display: true, text: "Quantity Used" } }
                        }
                    }
                });
            })
            .catch(error => console.error("Error loading Usage Trends data:", error));
    }

    // Function to generate random colors for each line
    function getRandomColor() {
        return `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`;
    }

    // Call the function to fetch and render the chart
    fetchUsageTrendsChart();


        // Fetch and render Employee Usage chart
        fetch("/report/employee-usage-data")
            .then(response => response.json())
            .then(data => {
                new Chart(document.getElementById("employeeUsageChart"), {
                    type: "bar",
                    data: {
                        labels: Object.keys(data),
                        datasets: [{ label: "Employee Usage", data: Object.values(data), backgroundColor: "rgba(255, 99, 132, 0.2)", borderColor: "rgba(255, 99, 132, 1)", borderWidth: 1 }]
                    }
                });
            });

        // Handle export buttons
        document.getElementById("exportButton").addEventListener("click", function () {
            window.location.href = "/export";
        });

        document.getElementById("mostUsedReportButton").addEventListener("click", function () {
            window.location.href = "/report/most-used";
        });

        document.getElementById("employeeReportButton").addEventListener("click", function () {
            window.location.href = "/report/employee-contributions";
        });

        document.getElementById("downloadLogButton").addEventListener("click", function () {
            window.location.href = "/download-log";
        });
    </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
        document.getElementById("sortItem").addEventListener("click", function() {
            // Get the table and its tbody
            var table = document.getElementById("stockTable");
            var tbody = table.tBodies[0];
            var rows = Array.from(tbody.getElementsByTagName("tr"));

            // Determine the current sort direction by checking for the actual arrow character
            var header = document.getElementById("sortItem");
            var isAscending = header.innerHTML.includes("▲");  // Check for actual ▲

            // Sort rows based on the text in the first cell ("Item" column)
            rows.sort(function(a, b) {
                var aText = a.cells[0].innerText.trim().toLowerCase();
                var bText = b.cells[0].innerText.trim().toLowerCase();
                if (aText < bText) return isAscending ? -1 : 1;
                if (aText > bText) return isAscending ? 1 : -1;
                return 0;
            });

            // Remove existing rows and re-append them in sorted order
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            rows.forEach(function(row) {
                tbody.appendChild(row);
            });

            // Toggle the arrow direction in the header
            if (isAscending) {
                header.innerHTML = "Item ▼"; // ▼ descending
            } else {
                header.innerHTML = "Item ▲"; // ▲ ascending
            }
        });
        </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>
