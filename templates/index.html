<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Inventory Tracker</h1>
        <h2 class="text-center mb-4">Software Created and Developed by Ron Zirk</h2>

        <div class="text-end">
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
        </div>

        <div class="card p-4 shadow-sm mb-4">
            <h3 class="text-center mb-3">Log Item Usage</h3>
            <form id="logForm" class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" name="item" placeholder="Item Name" required>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control" name="quantity" placeholder="Quantity Used" required>
                </div>
                
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary w-100">Log</button>
                </div>
            </form>
        </div>

        <div class="card p-4 shadow-sm mb-4">
            <h3 class="text-center mb-3">Add New Item</h3>
            <form id="addItemForm" class="row g-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" name="item" placeholder="Item Name" required>
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control" name="stock" placeholder="Initial Stock" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">Add</button>
                </div>
            </form>
        </div>

        <div class="table-responsive shadow-sm">
            <h3 class="text-center mb-3">Current Stock</h3>
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Item</th>
                        <th>Stock</th>
                        <th>Used</th>
                        <th>Remaining</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in data %}
                    <tr>
                        <td>{{ row['Item'] }}</td>
                        <td>{{ row['Stock'] }}</td>
                        <td>{{ row['Used'] }}</td>
                        <td>{{ row['Remaining'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if role == "Admin" %}
        <div class="d-flex justify-content-center mt-4 flex-wrap gap-3">
            <button id="exportButton" class="btn btn-success">Export Stock Data</button>
            <button id="mostUsedReportButton" class="btn btn-info">Download Most Used Report</button>
            <button id="employeeReportButton" class="btn btn-warning">Download Employee Report</button>
            <button id="downloadLogButton" class="btn btn-secondary">Download Log</button>
            <a href="{{ url_for('register') }}" class="btn btn-primary">Register New User</a>
            <a href="/admin" class="btn btn-secondary">Admin Dashboard</a>
        </div>
        {% endif %}

        <!-- Charts Section -->
        <div class="mt-5">
            <h3 class="text-center mb-3">Most Used Items</h3>
            <canvas id="mostUsedChart"></canvas>
        </div>

        <div id="usageTrendsChartContainer">
            <canvas id="usageTrendsChart"></canvas>
        </div>

        <div class="mt-5">
            <h3 class="text-center mb-3">Employee Usage</h3>
            <canvas id="employeeUsageChart"></canvas>
        </div>
    </div>

    <script>
        // Handle logging item usage
        document.getElementById("logForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/log", { method: "POST", body: formData })
                .then(response => response.json())
                .then(data => { alert(data.message); location.reload(); });
        });

        // Handle adding new items
        document.getElementById("addItemForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("/add-item", { method: "POST", body: formData })
                .then(response => response.json())
                .then(data => { alert(data.message); location.reload(); });
        });

        // Fetch and render Most Used Items chart
        fetch("/report/most-used-data")
            .then(response => response.json())
            .then(data => {
                new Chart(document.getElementById("mostUsedChart"), {
                    type: "bar",
                    data: {
                        labels: Object.keys(data),
                        datasets: [{ label: "Most Used Items", data: Object.values(data), backgroundColor: "rgba(75, 192, 192, 0.2)", borderColor: "rgba(75, 192, 192, 1)", borderWidth: 1 }]
                    }
                });
            });

        let usageTrendsChart; // Store chart instance globally

    function fetchUsageTrendsChart() {
        fetch("/report/usage-trends-data")
            .then(response => response.json())
            .then(data => {
                if (Object.keys(data).length === 0) {
                    console.warn("No data available for Usage Trends Over Time");
                    return;
                }

                const canvasContainer = document.getElementById("usageTrendsChartContainer");

                // Completely remove the old canvas and replace it with a new one
                canvasContainer.innerHTML = '<canvas id="usageTrendsChart"></canvas>';
                const ctx = document.getElementById("usageTrendsChart").getContext("2d");

                // Destroy previous chart instance if it exists
                if (usageTrendsChart) {
                    usageTrendsChart.destroy();
                }

                // Extract unique dates
                let allDates = new Set();
                for (let item in data) {
                    Object.keys(data[item]).forEach(date => allDates.add(date));
                }
                let sortedDates = Array.from(allDates).sort();

                // Prepare datasets for each item
                let datasets = [];
                for (let item in data) {
                    let itemData = sortedDates.map(date => data[item][date] || 0);

                    datasets.push({
                        label: item,
                        data: itemData,
                        borderWidth: 2,
                        fill: false,
                        borderColor: getRandomColor(),
                        backgroundColor: getRandomColor()
                    });
                }

                // Create new chart
                usageTrendsChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: sortedDates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: "Date" } },
                            y: { title: { display: true, text: "Quantity Used" } }
                        }
                    }
                });
            })
            .catch(error => console.error("Error loading Usage Trends data:", error));
    }

    // Function to generate random colors for each line
    function getRandomColor() {
        return `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`;
    }

    // Call the function to fetch and render the chart
    fetchUsageTrendsChart();


        // Fetch and render Employee Usage chart
        fetch("/report/employee-usage-data")
            .then(response => response.json())
            .then(data => {
                new Chart(document.getElementById("employeeUsageChart"), {
                    type: "bar",
                    data: {
                        labels: Object.keys(data),
                        datasets: [{ label: "Employee Usage", data: Object.values(data), backgroundColor: "rgba(255, 99, 132, 0.2)", borderColor: "rgba(255, 99, 132, 1)", borderWidth: 1 }]
                    }
                });
            });

        // Handle export buttons
        document.getElementById("exportButton").addEventListener("click", function () {
            window.location.href = "/export";
        });

        document.getElementById("mostUsedReportButton").addEventListener("click", function () {
            window.location.href = "/report/most-used";
        });

        document.getElementById("employeeReportButton").addEventListener("click", function () {
            window.location.href = "/report/employee-contributions";
        });

        document.getElementById("downloadLogButton").addEventListener("click", function () {
            window.location.href = "/download-log";
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
