<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-4">
    <h2>Inventory Log / Restock</h2>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mt-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Admin Controls -->
    {% if current_user.role == 'Admin' %}
      <div class="mb-3">
        <a class="btn btn-success" href="/export">Export Inventory</a>
        <a class="btn btn-danger" href="/download-log">Download Usage Log</a>
      </div>
    {% endif %}

    <!-- Category and Item Dropdowns -->
    <div class="mb-3">
      <label for="categorySelect" class="form-label">Select Category</label>
      <select id="categorySelect" class="form-select">
        <option selected disabled>Select a category</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="itemSelect" class="form-label">Select Item</label>
      <select id="itemSelect" name="item" class="form-select" disabled>
        <option selected disabled>Select a category first</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="quantity" class="form-label">Quantity</label>
      <input type="number" id="quantity" name="quantity" min="1" class="form-control" required>
    </div>

    <button id="logUsageBtn" class="btn btn-primary">Log Usage</button>
    <button id="restockBtn" class="btn btn-secondary ms-2">Restock Item</button>

    <!-- Inventory Table -->
    <hr>
    <h4 class="mt-4">Current Inventory</h4>
    {% for category, items in grouped_items.items() %}
      <h5 class="mt-3">{{ category }}</h5>
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>Item</th>
            <th>Used</th>
            <th>Remaining</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            <tr>
              <td>{{ item.item }}</td>
              <td>{{ item.used }}</td>
              <td>{{ item.remaining }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endfor %}

    <!-- Charts Section -->
    <hr>
    <div class="mt-5">
      <h4>Most Used Items</h4>
      <canvas id="most-used" height="100"></canvas>
    </div>

    <div class="mt-5">
      <h4>Usage Trends</h4>
      <canvas id="usage-trends" height="100"></canvas>
    </div>

    <div class="mt-5">
      <h4>Employee Usage</h4>
      <canvas id="employee-usage" height="100"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const categorySelect = document.getElementById("categorySelect");
    const itemSelect = document.getElementById("itemSelect");

    fetch("/inventory-map")
      .then(response => response.json())
      .then(data => {
        for (const category in data) {
          const option = document.createElement("option");
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        }

        categorySelect.addEventListener("change", () => {
          const selectedCategory = categorySelect.value;
          itemSelect.innerHTML = "<option selected disabled>Select Item</option>";
          itemSelect.disabled = false;

          data[selectedCategory].forEach(item => {
            const opt = document.createElement("option");
            opt.value = item;
            opt.textContent = item;
            itemSelect.appendChild(opt);
          });
        });
      });

    document.getElementById("logUsageBtn").addEventListener("click", () => {
      const item = itemSelect.value;
      const qty = document.getElementById("quantity").value;

      fetch("/log", {
        method: "POST",
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `item=${item}&quantity=${qty}`
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) location.reload();
      });
    });

    document.getElementById("restockBtn").addEventListener("click", () => {
      const item = itemSelect.value;
      const qty = document.getElementById("quantity").value;

      fetch("/add-item", {
        method: "POST",
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `item=${item}&stock=${qty}`
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.success) location.reload();
      });
    });

    // Load charts
    fetch("/most-used")
      .then(res => res.json())
      .then(data => {
        new Chart(document.getElementById("most-used"), data);
      });

    fetch("/usage-trends")
      .then(res => res.json())
      .then(data => {
        new Chart(document.getElementById("usage-trends"), data);
      });

    fetch("/employee-usage")
      .then(res => res.json())
      .then(data => {
        new Chart(document.getElementById("employee-usage"), data);
      });
  </script>
</body>
</html>
