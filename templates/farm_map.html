<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Farm Map Overview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="./static/styles.css">
    <style>
    .farm-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(10, 1fr);
      gap: 6px;
      max-width: 700px;
      margin: 0 auto;
      padding: 10px;
    }
    .farm-plot {
      background: url('/static/images/soil-texture.jpg');
      background-size: cover;
      border: 2px solid rgba(0, 0, 0, 0.2);
      aspect-ratio: 1 / 1;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 0.8rem;
      color: white;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .farm-plot:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .plot-label {
      line-height: 1.2;
      background-color: rgba(0, 0, 0, 0.4);
      padding: 4px 6px;
      border-radius: 4px;
    }
    .crop-label {
      font-size: 0.75rem;
      font-weight: 400;
      display: inline-block;
      margin-top: 2px;
    }
    .status-Empty {
      background-color: #777;
    }
    .status-Planted {
      background-color: #4caf50;
    }
    .status-Needs-Water {
      background-color: #2196f3;
    }
    .status-Harvest-Ready {
      background-color: #ff9800;
    }
  </style>
</head>
<body>
{% include 'navbar.html' %}

<div class="container mt-4 text-center">
  <h1 class="mb-3">Farm Overview Map</h1>
  <p class="text-muted">Click on a plot to view or edit its crop and status.</p>
  <div class="farm-grid">
    {% for plot in plots %}
      <div
        class="farm-plot status-{{ plot.status.replace(' ', '-') }}"
        data-bs-toggle="tooltip"
        title="Plot {{ plot.plot_number }} â€” {{ plot.crop or 'Empty' }} ({{ plot.status }})"
        data-plot="{{ plot.id }}"
        data-crop="{{ plot.crop or 'None' }}"
        data-status="{{ plot.status }}"
        onclick='openPlotModal({{ plot.plot_number }}, {{ plot.crop | tojson }}, {{ plot.status | tojson }})'

      >
        <div class="plot-label">
          <strong>#{{ plot.plot_number }}</strong><br>
          <span class="crop-label">
            {{ plot.crop or 'Empty' }}
            {% if plot.status == 'Needs Water' %}ðŸ’§{% elif plot.status == 'Harvest Ready' %}ðŸŒ¾{% elif plot.status == 'Planted' %}ðŸŒ±{% endif %}
          </span>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Plot Modal -->
<div class="modal fade" id="plotModal" tabindex="-1" aria-labelledby="plotModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="plotModalLabel">Plot Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="plotForm">
          <input type="hidden" id="plotNumberField">
          <div class="mb-3">
            <label for="cropField" class="form-label">Crop</label>
            <input type="text" class="form-control" id="cropField">
          </div>
          <div class="mb-3">
            <label for="statusField" class="form-label">Status</label>
            <select class="form-select" id="statusField">
              <option value="Empty">Empty</option>
              <option value="Planted">Planted</option>
              <option value="Needs Water">Needs Water</option>
              <option value="Harvest Ready">Harvest Ready</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function openPlotModal(plotId, crop, status) {
    document.getElementById('plotNumberField').value = plotId;
    document.getElementById('cropField').value = crop;
    document.getElementById('statusField').value = status;
    var modal = new bootstrap.Modal(document.getElementById('plotModal'));
    modal.show();
  }

  document.getElementById('plotForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const plotId = document.getElementById('plotNumberField').value;
    const crop = document.getElementById('cropField').value;
    const status = document.getElementById('statusField').value;

    fetch(`/update-plot/${plotId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ crop: crop, status: status })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const plotCell = document.querySelector(`.farm-plot[data-plot="${plotId}"]`);
        plotCell.dataset.crop = crop;
        plotCell.dataset.status = status;
        plotCell.className = `farm-plot status-${status.replace(' ', '-')}`;
        plotCell.querySelector('.plot-label').innerHTML = `
          <strong>#${plotCell.innerText.split('\n')[0].replace('#', '')}</strong><br>
          <span class="crop-label">
            ${crop || 'Empty'}
            ${status === 'Needs Water' ? 'ðŸ’§' : status === 'Harvest Ready' ? 'ðŸŒ¾' : status === 'Planted' ? 'ðŸŒ±' : ''}
          </span>
        `;
        bootstrap.Modal.getInstance(document.getElementById('plotModal')).hide();
      } else {
        console.error(data.message);
        alert(data.message);
      }
    });
  });

  // Enable Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', function () {
    const tooltipList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
</body>
</html>
